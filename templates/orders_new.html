{% extends 'layout.html' %}
{% from '_pagination.html' import render_pagination %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Daftar Transaksi</h1>
    <div class="d-flex align-items-center">
        <div id="batchActionContainer" style="display: none;">
            <button id="batchEditBtn" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#batchEditModal">Ubah<span class="d-none d-sm-inline"> yang Dipilih</span></button>
            <button id="batchDeleteBtn" class="btn btn-danger me-3">Hapus<span class="d-none d-sm-inline"> yang Dipilih</span></button>
        </div>
        <div class="me-3" style="width: 300px;">
            <input type="text" id="searchInput" class="form-control" placeholder="Cari nota, kode, atau nama..." value="{{ search }}">
        </div>
        <a href="{{ url_for('new_order') }}" class="btn btn-primary">Tambah Order Baru</a>
    </div>
</div>

<div id="selectAllMessageContainer" class="mb-3" style="display: none;">
    <div id="selectPageMessage" class="alert alert-info d-flex justify-content-between align-items-center">
        <span>Semua <strong>{{ pagination.per_page }}</strong> item di halaman ini telah dipilih.</span>
        <a href="#" id="selectAllFilteredLink" class="alert-link">Pilih semua <strong>{{ pagination.total }}</strong> item yang cocok.</a>
    </div>
    <div id="clearSelectionMessage" class="alert alert-warning d-flex justify-content-between align-items-center" style="display: none;">
        <span>Semua <strong>{{ pagination.total }}</strong> item yang cocok telah dipilih.</span>
        <a href="#" id="clearSelectionLink" class="alert-link">Batalkan pilihan.</a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th class="text-center" style="width: 50px;">
                    <input type="checkbox" id="pageSelectCheckbox" class="form-check-input">
                </th>
                <th>Tanggal</th>
                <th>No. Nota</th>
                <th>Kode Barang</th>
                <th>Nama Barang</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Total Harga (Rp)</th>
                <th class="text-center">Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for order in pagination.items %}
            <tr data-id="{{ order.id }}">
                <td class="text-center"><input type="checkbox" class="form-check-input item-checkbox" value="{{ order.id }}"></td>
                <td>{{ order.date.strftime('%Y-%m-%d') }}</td>
                <td>{{ order.regno }}</td>
                <td>{{ order.kode }}</td>
                <td>{{ order.nama }}</td>
                <td class="text-end">{{ order.qty }}</td>
                <td class="text-end">{{ '{:,.0f}'.format(order.jumlah) }}</td>
                <td class="text-center">
                    <a href="{{ url_for('edit_order', id=order.id) }}" class="btn btn-sm btn-info">Edit</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">Tidak ada data untuk ditampilkan.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{{ render_pagination(pagination, 'orders_list') }}

{% include '_batch_edit_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State & Elemen ---
    let allItemsFilteredSelected = false;
    let selectedIds = new Set();
    
    const pageSelectCheckbox = document.getElementById('pageSelectCheckbox');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    const batchActionContainer = document.getElementById('batchActionContainer');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    const searchInput = document.getElementById('searchInput');
    const saveBatchEditBtn = document.getElementById('saveBatchEdit');
    
    const selectAllMessageContainer = document.getElementById('selectAllMessageContainer');
    const selectPageMessage = document.getElementById('selectPageMessage');
    const clearSelectionMessage = document.getElementById('clearSelectionMessage');
    const selectAllFilteredLink = document.getElementById('selectAllFilteredLink');
    const clearSelectionLink = document.getElementById('clearSelectionLink');
    
    // --- Fungsi Bantuan ---
    function updateUiState() {
        const areAllOnPageChecked = itemCheckboxes.length > 0 && Array.from(itemCheckboxes).every(cb => cb.checked);
        pageSelectCheckbox.checked = areAllOnPageChecked;
        
        const count = selectedIds.size;
        batchActionContainer.style.display = count > 0 ? 'flex' : 'none';
        if (count > 0) selectedCountSpan.textContent = count;

        if (allItemsFilteredSelected) {
            selectAllMessageContainer.style.display = 'block';
            selectPageMessage.style.display = 'none';
            clearSelectionMessage.style.display = 'flex';
        } else {
            clearSelectionMessage.style.display = 'none';
            if (areAllOnPageChecked && itemCheckboxes.length < {{ pagination.total }}) {
                selectAllMessageContainer.style.display = 'block';
                selectPageMessage.style.display = 'flex';
            } else {
                selectAllMessageContainer.style.display = 'none';
            }
        }
    }

    function selectItemsOnPage(select) {
        itemCheckboxes.forEach(cb => {
            cb.checked = select;
            if (select) selectedIds.add(cb.value);
            else selectedIds.delete(cb.value);
        });
        allItemsFilteredSelected = false;
        updateUiState();
    }

    // --- Event Listeners ---
    pageSelectCheckbox.addEventListener('change', () => selectItemsOnPage(pageSelectCheckbox.checked));

    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (checkbox.checked) selectedIds.add(checkbox.value);
            else {
                selectedIds.delete(checkbox.value);
                allItemsFilteredSelected = false;
            }
            updateUiState();
        });
    });

    selectAllFilteredLink.addEventListener('click', (e) => {
        e.preventDefault();
        const currentUrlParams = new URLSearchParams(window.location.search);
        fetch(`{{ url_for('get_all_order_ids') }}?${currentUrlParams.toString()}`)
            .then(res => res.json())
            .then(data => {
                data.ids.forEach(id => selectedIds.add(id.toString()));
                allItemsFilteredSelected = true;
                updateUiState();
            });
    });

    clearSelectionLink.addEventListener('click', (e) => {
        e.preventDefault();
        selectedIds.clear();
        allItemsFilteredSelected = false;
        selectItemsOnPage(false);
    });

    batchDeleteBtn.addEventListener('click', () => {
        const ids = Array.from(selectedIds);
        if(confirm(`Yakin ingin menghapus ${ids.length} order yang dipilih? Stok akan dikembalikan.`)) {
            fetch('{{ url_for("batch_delete_order") }}', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            }).then(res => res.json()).then(data => {
                if(data.success) window.location.reload();
                else alert('Gagal menghapus: ' + data.message);
            });
        }
    });

    saveBatchEditBtn.addEventListener('click', () => {
        const ids = Array.from(selectedIds);
        const field = document.getElementById('fieldSelect').value;
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        fetch('{{ url_for("batch_update_order") }}', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: ids, field, find_text: findText, replace_text: replaceText })
        }).then(res => res.json()).then(data => {
            if(data.success) {
                alert(data.message);
                window.location.reload();
            } else { alert('Gagal memperbarui: ' + data.message); }
        });
    });

    let searchTimeout;
    searchInput.addEventListener('keyup', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            window.location.href = `{{ url_for('orders_list') }}?search=${encodeURIComponent(searchInput.value)}`;
        }, 500);
    });
});
</script>
{% endblock %}